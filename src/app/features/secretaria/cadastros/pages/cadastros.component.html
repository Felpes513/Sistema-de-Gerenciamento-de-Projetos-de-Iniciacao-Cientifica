<section class="cadastros" [class.loading]="carregando">
  <header class="tabs">
    <button
      class="tab"
      [class.active]="aba === 'APROVACoes'"
      (click)="setAba('APROVACoes')"
    >
      Aprovações
    </button>
    <button
      class="tab"
      [class.active]="aba === 'INADIMPLENTES'"
      (click)="setAba('INADIMPLENTES')"
    >
      Inadimplentes
    </button>

    <ng-container *ngIf="aba === 'APROVACoes'">
      <div class="split"></div>
      <button
        class="subtab"
        [class.active]="tipo === 'ALUNOS'"
        (click)="setTipo('ALUNOS')"
      >
        Alunos
      </button>
      <button
        class="subtab"
        [class.active]="tipo === 'ORIENTADORES'"
        (click)="setTipo('ORIENTADORES')"
      >
        Orientadores
      </button>

      <div class="toolbar" style="margin-left: auto; min-width: 260px">
        <div class="search" style="width: 100%">
          <span class="icon"><i class="fas fa-search"></i></span>
          <input
            type="text"
            placeholder="filtrar por nome/email/cpf"
            [(ngModel)]="filtro"
          />
        </div>
      </div>
    </ng-container>
  </header>

  <div *ngIf="erro" class="erro">{{ erro }}</div>

  <table
    class="table"
    *ngIf="!carregando && aba === 'APROVACoes' && tipo === 'ALUNOS'"
  >
    <thead>
      <tr>
        <th>Nome</th>
        <th>Email</th>
        <th>CPF</th>
        <th>Status</th>
        <th>PDF</th>
        <th class="col-actions">Ações</th>
      </tr>
    </thead>
    <tbody>
      <tr
        *ngFor="let a of alunos"
        [hidden]="
          filtro &&
          !match(
            filtro,
            a.nomeFmt || a.nome_completo,
            a.email,
            a.cpfFmt || a.cpf
          )
        "
      >
        <td
          data-label="Nome"
          class="col-nome"
          [title]="a.nomeFmt || a.nome_completo"
        >
          {{ a.nomeFmt || a.nome_completo }}
        </td>
        <td data-label="Email">{{ a.email }}</td>
        <td data-label="CPF">{{ a.cpfFmt || a.cpf }}</td>
        <td data-label="Status">
          <span
            class="badge"
            [class.aprovado]="isAprovado(a)"
            [class.reprovado]="isReprovado(a)"
            [class.inadimplente]="isInadimplente(a)"
            [class.pendente]="isPendente(a)"
          >
            {{ statusLabel(a) }}
          </span>
        </td>

        <td data-label="PDF">{{ a.has_pdf ? "✓" : "—" }}</td>
        <td class="col-actions" data-label="Ações">
          <button
            *ngIf="isPendente(a) || isReprovado(a)"
            class="btn btn-approve"
            (click)="aprovar(a.id)"
          >
            Aprovar
          </button>

          <button
            *ngIf="isPendente(a)"
            class="btn btn-reject"
            (click)="reprovar(a.id)"
          >
            Reprovar
          </button>

          <button
            *ngIf="isAprovado(a)"
            class="btn btn-inad"
            (click)="inadimplentar(a.id)"
          >
            Inadimplentar
          </button>

          <button
            *ngIf="isInadimplente(a)"
            class="btn btn-approve"
            (click)="adimplentar(a.id)"
          >
            Adimplentar
          </button>

          <a
            *ngIf="a.has_pdf"
            class="btn"
            [href]="'/api/alunos/' + a.id + '/pdf'"
            target="_blank"
          >
            PDF
          </a>
        </td>
      </tr>
    </tbody>
  </table>

  <table
    class="table"
    *ngIf="!carregando && aba === 'APROVACoes' && tipo === 'ORIENTADORES'"
  >
    <thead>
      <tr>
        <th>Nome</th>
        <th>Email</th>
        <th>CPF</th>
        <th>Status</th>
        <th class="col-actions">Ações</th>
      </tr>
    </thead>
    <tbody>
      <tr
        *ngFor="let o of orientadores"
        [hidden]="
          filtro &&
          !match(
            filtro,
            o.nomeFmt || o.nome_completo,
            o.email,
            o.cpfFmt || o.cpf
          )
        "
      >
        <td
          data-label="Nome"
          class="col-nome"
          [title]="o.nomeFmt || o.nome_completo"
        >
          {{ o.nomeFmt || o.nome_completo }}
        </td>
        <td data-label="Email">{{ o.email }}</td>
        <td data-label="CPF">{{ o.cpfFmt || o.cpf }}</td>
        <td data-label="Status">
          <span
            class="badge"
            [class.aprovado]="isAprovado(o)"
            [class.reprovado]="isReprovado(o)"
            [class.inadimplente]="isInadimplente(o)"
            [class.pendente]="isPendente(o)"
          >
            {{ statusLabel(o) }}
          </span>
        </td>

        <td class="col-actions" data-label="Ações">
          <button
            *ngIf="isPendente(o) || isReprovado(o)"
            class="btn btn-approve"
            (click)="aprovar(o.id)"
          >
            Aprovar
          </button>

          <button
            *ngIf="isPendente(o)"
            class="btn btn-reject"
            (click)="reprovar(o.id)"
          >
            Reprovar
          </button>

          <button
            *ngIf="isAprovado(o)"
            class="btn btn-inad"
            (click)="inadimplentar(o.id)"
          >
            Inadimplentar
          </button>

          <button
            *ngIf="isInadimplente(o)"
            class="btn btn-approve"
            (click)="adimplentar(o.id)"
          >
            Adimplentar
          </button>
        </td>
      </tr>
    </tbody>
  </table>

  <ng-container *ngIf="!carregando && aba === 'INADIMPLENTES'">
    <h3 class="inad-section-title">Alunos</h3>
    <table class="table inad-table">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Email</th>
          <th>CPF</th>
          <th>Inadimplente até</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let a of alunosInad">
          <td data-label="Nome">{{ a.nomeFmt || a.nome_completo }}</td>
          <td data-label="Email">{{ a.email }}</td>
          <td data-label="CPF">{{ a.cpfFmt || a.cpf }}</td>
          <td data-label="Inadimplente até">
            {{ a.inadimplente_ate | date : "shortDate" }}
          </td>
        </tr>
      </tbody>
    </table>

    <h3 class="inad-section-title">Orientadores</h3>
    <table class="table inad-table">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Email</th>
          <th>CPF</th>
          <th>Inadimplente até</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let o of orientadoresInad">
          <td data-label="Nome">{{ o.nomeFmt || o.nome_completo }}</td>
          <td data-label="Email">{{ o.email }}</td>
          <td data-label="CPF">{{ o.cpfFmt || o.cpf }}</td>
          <td data-label="Inadimplente até">
            {{ o.inadimplente_ate | date : "shortDate" }}
          </td>
        </tr>
      </tbody>
    </table>
  </ng-container>
</section>
