<section class="painel" [class.loading]="loading">
  <header class="head">
    <h3 *ngIf="modo === 'SECRETARIA'">Alunos ({{ total }})</h3>
    <h3 *ngIf="modo === 'ORIENTADOR'">Selecionar alunos ({{ total }})</h3>
  </header>

  <ng-container *ngIf="loading; else conteudo">
    <div class="skeleton">
      <div
        class="sk-row"
        *ngFor="let _ of skeletonRows; trackBy: trackByIndex"
      ></div>
    </div>
  </ng-container>

  <ng-template #conteudo>
    <!-- TEMPLATE REUTILIZÁVEL (SECRETARIA) -->
    <ng-template #alunoCard let-a>
      <div class="aluno-card">
        <div class="dados">
          <strong class="nome" [title]="a.nome">
            <mat-icon class="avatar-icon">person</mat-icon>
            <span class="nome-texto">{{ a.nome }}</span>

            <span
              *ngIf="a.possuiTrabalhoRemunerado"
              class="badge remunerado"
              title="Possui trabalho remunerado"
            >
              <mat-icon class="badge-icon">work</mat-icon>
              Remunerado
            </span>
          </strong>

          <div class="mini">
            <span>RA: {{ a.matricula }}</span>
            <span>Email: {{ a.email }}</span>
            <span>
              Status:
              <b>{{ a.status }}</b>
            </span>
          </div>

          <div class="links" *ngIf="a.documentoNotasUrl">
            <a [href]="a.documentoNotasUrl" target="_blank" rel="noopener">
              <mat-icon class="link-icon">description</mat-icon>
              Visualizar Notas
            </a>
          </div>
        </div>
      </div>
    </ng-template>

    <!-- ======================= SECRETARIA ======================= -->
    <ng-container *ngIf="modo === 'SECRETARIA'">
      <!-- Se já houve seleção final: split (Selecionados / Disponíveis) -->
      <ng-container *ngIf="temSelecaoFinal; else listaSecretariaNormal">
        <ng-container
          *ngIf="
            secretariaSelecionados.length + secretariaDisponiveis.length;
            else vazio
          "
        >
          <div class="split-root">
            <div class="split-container">
              <div class="split-pane">
                <h4>Selecionados ({{ secretariaSelecionados.length }})</h4>

                <ng-container
                  *ngIf="
                    secretariaSelecionados.length;
                    else nenhumSelecionadoSecretaria
                  "
                >
                  <ul class="lista" role="list">
                    <li
                      class="item"
                      *ngFor="
                        let a of secretariaSelecionados;
                        trackBy: trackByVM
                      "
                    >
                      <ng-container
                        *ngTemplateOutlet="
                          alunoCard;
                          context: { $implicit: a }
                        "
                      ></ng-container>
                    </li>
                  </ul>
                </ng-container>

                <ng-template #nenhumSelecionadoSecretaria>
                  <p class="muted">Nenhum aluno selecionado ainda.</p>
                </ng-template>
              </div>

              <div class="split-pane">
                <h4>Disponíveis ({{ secretariaDisponiveis.length }})</h4>

                <ng-container
                  *ngIf="
                    secretariaDisponiveis.length;
                    else nenhumDisponivelSecretaria
                  "
                >
                  <ul class="lista" role="list">
                    <li
                      class="item"
                      *ngFor="
                        let a of secretariaDisponiveis;
                        trackBy: trackByVM
                      "
                    >
                      <ng-container
                        *ngTemplateOutlet="
                          alunoCard;
                          context: { $implicit: a }
                        "
                      ></ng-container>
                    </li>
                  </ul>
                </ng-container>

                <ng-template #nenhumDisponivelSecretaria>
                  <p class="muted">Nenhum aluno disponível no momento.</p>
                </ng-template>
              </div>
            </div>
          </div>
        </ng-container>
      </ng-container>

      <!-- Lista normal (antes da seleção final) -->
      <ng-template #listaSecretariaNormal>
        <ng-container *ngIf="secretariaListaNormal.length; else vazio">
          <ul class="lista" role="list">
            <li
              class="item"
              *ngFor="let a of secretariaListaNormal; trackBy: trackByVM"
            >
              <ng-container
                *ngTemplateOutlet="alunoCard; context: { $implicit: a }"
              ></ng-container>
            </li>
          </ul>
        </ng-container>
      </ng-template>
    </ng-container>

    <!-- ======================= ORIENTADOR ======================= -->
    <ng-container *ngIf="modo === 'ORIENTADOR'">
      <div class="split-root" *ngIf="aprovadasVm.length; else nenhumAprovado">
        <div class="split-container">
          <div class="split-pane">
            <h4>Selecionados ({{ orientadorSelecionados.length }})</h4>

            <ng-container
              *ngIf="orientadorSelecionados.length; else nenhumSelecionado"
            >
              <ul class="lista" role="list">
                <li
                  class="item"
                  *ngFor="
                    let i of orientadorSelecionados;
                    let last = last;
                    trackBy: trackByVM
                  "
                >
                  <label class="linha">
                    <input
                      type="checkbox"
                      [checked]="selecionados.has(i.alunoId)"
                      [disabled]="disabledCheckboxByAlunoId(i.alunoId)"
                      (change)="onSelecionadoChange($event, i.alunoId)"
                      role="switch"
                      [attr.aria-label]="'Selecionar aluno ' + i.nome"
                      [attr.aria-checked]="selecionados.has(i.alunoId)"
                      [attr.aria-disabled]="
                        disabledCheckboxByAlunoId(i.alunoId) ? 'true' : null
                      "
                    />

                    <div class="dados">
                      <strong class="nome" [title]="i.nome">
                        <mat-icon class="avatar-icon">person</mat-icon>
                        <span class="nome-texto">{{ i.nome }}</span>
                      </strong>

                      <div class="mini">
                        <span>RA: {{ i.matricula }}</span>
                        <span class="sep">•</span>
                        <span>Email: {{ i.email }}</span>
                        <span class="sep">•</span>
                        <span
                          >Status: <b>{{ i.status }}</b></span
                        >
                      </div>
                    </div>
                  </label>

                  <mat-divider *ngIf="!last"></mat-divider>
                </li>
              </ul>
            </ng-container>

            <ng-template #nenhumSelecionado>
              <p class="muted">Nenhum aluno selecionado ainda.</p>
            </ng-template>
          </div>

          <div class="split-pane">
            <h4>Disponíveis ({{ orientadorDisponiveis.length }})</h4>

            <ng-container
              *ngIf="orientadorDisponiveis.length; else nenhumDisponivel"
            >
              <ul class="lista" role="list">
                <li
                  class="item"
                  *ngFor="
                    let i of orientadorDisponiveis;
                    let last = last;
                    trackBy: trackByVM
                  "
                >
                  <label class="linha">
                    <input
                      type="checkbox"
                      [checked]="selecionados.has(i.alunoId)"
                      [disabled]="disabledCheckboxByAlunoId(i.alunoId)"
                      (change)="onSelecionadoChange($event, i.alunoId)"
                      role="switch"
                      [attr.aria-label]="'Selecionar aluno ' + i.nome"
                      [attr.aria-checked]="selecionados.has(i.alunoId)"
                      [attr.aria-disabled]="
                        disabledCheckboxByAlunoId(i.alunoId) ? 'true' : null
                      "
                    />

                    <div class="dados">
                      <strong class="nome" [title]="i.nome">
                        <mat-icon class="avatar-icon">person</mat-icon>
                        <span class="nome-texto">{{ i.nome }}</span>
                      </strong>

                      <div class="mini">
                        <span>RA: {{ i.matricula }}</span>
                        <span class="sep">•</span>
                        <span>Email: {{ i.email }}</span>
                        <span class="sep">•</span>
                        <span
                          >Status: <b>{{ i.status }}</b></span
                        >
                      </div>
                    </div>
                  </label>

                  <mat-divider *ngIf="!last"></mat-divider>
                </li>
              </ul>
            </ng-container>

            <ng-template #nenhumDisponivel>
              <p class="muted">Nenhum aluno disponível no momento.</p>
            </ng-template>
          </div>
        </div>
      </div>

      <ng-template #nenhumAprovado>
        <p class="muted">Nenhum aluno aprovado pela Secretaria ainda.</p>
      </ng-template>

      <div class="form-actions" style="margin-top: 12px">
        <button
          type="button"
          (click)="salvarSelecao()"
          [disabled]="
            salvandoSelecao || (limite > 0 && selecionados.size > limite)
          "
        >
          {{
            salvandoSelecao
              ? "Salvando..."
              : bloqueado
              ? "Salvar alterações"
              : "Salvar seleção"
          }}
        </button>

        <span class="ok" *ngIf="sucessoSelecao">{{ sucessoSelecao }}</span>
        <span class="erro" *ngIf="erroSalvarSelecao">{{
          erroSalvarSelecao
        }}</span>

        <div class="mini" style="margin-top: 4px">
          Selecionados: {{ selecionados.size }}
          <span *ngIf="limite">/ Limite: {{ limite }}</span>
        </div>

        <p class="muted" *ngIf="bloqueado" style="margin-top: 4px">
          Seleção já registrada anteriormente. Você pode ajustar e salvar
          novamente.
        </p>
      </div>
    </ng-container>
  </ng-template>

  <!-- vazio: usado na SECRETARIA -->
  <ng-template #vazio>
    <div class="vazio">
      <h4>Nenhum aluno inscrito ainda</h4>
      <p>Quando houver inscrições neste projeto, elas aparecerão aqui.</p>
    </div>
  </ng-template>
</section>
