<div class="config-page">
  <h2>Configurações do Sistema</h2>
  <p class="muted">Gerencie campus, cursos, bolsas e secretarias</p>

  <mat-tab-group>
    <mat-tab label="Campus">
      <div class="form-section">
        <h3>Cadastrar Campus</h3>
        <form (ngSubmit)="cadastrarCampus()">
          <input
            type="text"
            [(ngModel)]="novoCampus"
            name="nomeCampus"
            placeholder="Nome do campus"
            required
          />
          <button type="submit">Salvar</button>
        </form>

        <h4>Campus cadastrados</h4>
        <ul class="list">
          <li *ngFor="let c of campus">
            <span>{{ c.campus }}</span>
            <button
              class="danger"
              type="button"
              (click)="excluirCampus(c.id_campus)"
            >
              Excluir
            </button>
          </li>
        </ul>
      </div>
    </mat-tab>

    <mat-tab label="Cursos">
      <div class="form-section">
        <h3>Cadastrar Curso</h3>
        <form (ngSubmit)="cadastrarCurso()">
          <input
            type="text"
            [(ngModel)]="novoCurso"
            name="nomeCurso"
            placeholder="Nome do curso"
            required
          />
          <button type="submit">Salvar</button>
        </form>

        <h4>Cursos cadastrados</h4>
        <ul class="list">
          <li *ngFor="let c of cursos">
            <span>{{ c.nome }}</span>
            <button
              class="danger"
              type="button"
              (click)="excluirCurso(c.id_curso)"
            >
              Excluir
            </button>
          </li>
        </ul>
      </div>
    </mat-tab>

    <mat-tab label="Bolsas">
      <div class="form-section">
        <h3>Cadastrar Tipo de Bolsa</h3>

        <form (ngSubmit)="criarTipoBolsa()" class="crud-inline">
          <input
            type="text"
            [(ngModel)]="novoTipoBolsa"
            name="tipoBolsa"
            placeholder="Ex: PIBIC, PIBITI, Voluntária..."
            required
          />
          <button type="submit">Salvar</button>
        </form>

        <h4>Tipos de Bolsa Cadastrados</h4>
        <ul class="list">
          <li *ngFor="let t of tiposBolsa">
            <span>{{ t.tipo_bolsa }}</span>
            <button
              class="danger"
              type="button"
              (click)="excluirTipoBolsa(t.id_tipo_bolsa)"
            >
              Excluir
            </button>
          </li>
        </ul>

        <hr class="section-divider" />

        <h3>Atribuição de Bolsa para Alunos</h3>

        <div class="bolsas-filter">
          <input
            type="text"
            [(ngModel)]="filtroBolsa"
            name="filtroBolsa"
            placeholder="Filtrar por nome ou e-mail"
          />
        </div>

        <div class="table-bolsas-wrapper" *ngIf="alunos.length">
          <table class="table table-bolsas">
            <thead>
              <tr>
                <th>Aluno</th>
                <th>Email</th>
                <th>Bolsas Atuais</th>
                <th>Ações</th>
              </tr>
            </thead>

            <tbody>
              <tr
                *ngFor="let a of alunos"
                [hidden]="!matchBolsa(filtroBolsa, a.nome_completo, a.email)"
              >
                <td>{{ toTitleCase(a.nome_completo) }}</td>
                <td>{{ a.email }}</td>

                <td>
                  <div *ngIf="a.bolsas.length; else semBolsa">
                    <span *ngFor="let b of a.bolsas" class="tag">
                      {{ b.tipo_bolsa }}
                      <button
                        class="tag-remove"
                        type="button"
                        (click)="removerBolsa(b.id_bolsa)"
                      >
                        x
                      </button>
                    </span>
                  </div>

                  <ng-template #semBolsa>
                    <span class="muted">Nenhuma bolsa</span>
                  </ng-template>
                </td>

                <td>
                  <button type="button" (click)="abrirSelecaoBolsa(a)">
                    Vincular Bolsa
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="modal-backdrop" *ngIf="modalBolsaAberto">
        <div class="modal">
          <h3>Vincular Bolsa</h3>
          <p class="modal-aluno">
            <span class="label">Aluno:</span>
            <strong>{{ toTitleCase(alunoSelecionado?.nome_completo) }}</strong>
          </p>

          <select [(ngModel)]="bolsaSelecionada" name="tiposBolsaSelect">
            <option [ngValue]="null" disabled>Selecione o tipo de bolsa</option>
            <option *ngFor="let t of tiposBolsa" [ngValue]="t.id_tipo_bolsa">
              {{ t.tipo_bolsa }}
            </option>
          </select>

          <div class="modal-actions">
            <button type="button" (click)="confirmarVinculo()">Salvar</button>
            <button class="danger" type="button" (click)="fecharModal()">
              Cancelar
            </button>
          </div>
        </div>
      </div>
    </mat-tab>

    <mat-tab label="Secretarias">
      <div class="form-section">
        <h3>Cadastrar Secretaria</h3>

        <form (ngSubmit)="cadastrarSecretaria()" class="sec-form">
          <div class="sec-field span-2">
            <label>Nome completo</label>
            <input
              type="text"
              name="sec_nome"
              [(ngModel)]="sec.nomeCompleto"
              placeholder="Nome completo"
              required
              minlength="3"
              [class.invalid]="secTouched.nome && !sec.nomeCompleto.trim()"
              (blur)="secTouched.nome = true"
            />
          </div>

          <div class="sec-field">
            <label>E-mail</label>
            <input
              type="email"
              name="sec_email"
              [(ngModel)]="sec.email"
              placeholder="E-mail"
              required
              [class.invalid]="secTouched.email && !isEmailValid(sec.email)"
              (blur)="secTouched.email = true"
            />
            <small
              class="sec-hint error"
              *ngIf="secTouched.email && !isEmailValid(sec.email)"
            >
              E-mail inválido
            </small>
          </div>

          <div class="sec-field">
            <label>CPF</label>
            <input
              type="text"
              name="sec_cpf"
              [(ngModel)]="sec.cpf"
              placeholder="CPF"
              required
              (blur)="onSecCpfBlur()"
              [class.invalid]="secTouched.cpf && !isCpfValido(sec.cpf)"
            />
            <small
              class="sec-hint error"
              *ngIf="secTouched.cpf && !isCpfValido(sec.cpf)"
            >
              CPF inválido
            </small>
          </div>

          <div class="sec-field">
            <label>Senha</label>
            <input
              type="password"
              name="sec_senha"
              [(ngModel)]="sec.senha"
              placeholder="Senha (mín. 6 dígitos)"
              required
              minlength="6"
              (blur)="secTouched.senha = true"
              [class.invalid]="secTouched.senha && !isSenhaValida(sec.senha)"
            />
            <small
              class="sec-hint error"
              *ngIf="secTouched.senha && !isSenhaValida(sec.senha)"
            >
              Senha deve ter no mínimo 6 caracteres
            </small>
          </div>

          <div class="sec-field">
            <label>Confirmar senha</label>
            <input
              type="password"
              name="sec_confirmar"
              [(ngModel)]="sec.confirmar"
              placeholder="Confirmar senha"
              required
              (blur)="secTouched.confirmar = true"
              [class.invalid]="
                secTouched.confirmar &&
                !!sec.confirmar &&
                sec.senha !== sec.confirmar
              "
            />
            <small
              class="sec-hint error"
              *ngIf="
                secTouched.confirmar &&
                !!sec.confirmar &&
                sec.senha !== sec.confirmar
              "
            >
              Senhas não conferem
            </small>
          </div>

          <div class="sec-actions span-2">
            <button
              type="submit"
              [disabled]="secLoading || !canSubmitSecretaria()"
            >
              {{ secLoading ? "Salvando..." : "Salvar" }}
            </button>
          </div>

          <div class="sec-msg erro" *ngIf="secErro">{{ secErro }}</div>
          <div class="sec-msg sucesso" *ngIf="secSucesso">{{ secSucesso }}</div>
        </form>

        <hr class="section-divider" />

        <h3>Secretarias cadastradas</h3>

        <div
          class="table-secretarias-wrapper"
          *ngIf="secretarias.length; else semSecretarias"
        >
          <table class="table table-secretarias">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Email</th>
                <th>CPF</th>
                <th>Ações</th>
              </tr>
            </thead>

            <tbody>
              <tr *ngFor="let s of secretarias">
                <td>{{ toTitleCase(s.nome_completo) }}</td>
                <td>{{ s.email }}</td>
                <td>{{ formatCpf(s.cpf) }}</td>
                <td class="sec-actions-col">
                  <button
                    type="button"
                    class="btn-reset"
                    (click)="resetarSenhaSecretaria(s)"
                    [disabled]="resetPwdLoadingId === s.id"
                  >
                    {{
                      resetPwdLoadingId === s.id
                        ? "Enviando..."
                        : "Resetar senha"
                    }}
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <ng-template #semSecretarias>
          <p class="muted" style="margin-top: 8px">
            {{
              secretariasLoading
                ? "Carregando..."
                : "Nenhuma secretaria cadastrada."
            }}
          </p>
        </ng-template>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
