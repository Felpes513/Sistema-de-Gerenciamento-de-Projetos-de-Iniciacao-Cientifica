<div class="projects-container">
  <div class="header">
    <h2>{{ tituloLista }}</h2>

    <div class="filters" *ngIf="isSecretaria">
      <input
        type="text"
        placeholder="Buscar por projeto, orientador ou campus"
        [(ngModel)]="filtro"
        (ngModelChange)="onFiltroChange($event)"
        class="search-input"
      />
      <button class="btn-reload" (click)="recarregar()" [disabled]="carregando">
        <mat-icon>refresh</mat-icon>
        Recarregar
      </button>
      <button class="btn-add" [routerLink]="['/secretaria/projetos/novo']">
        <mat-icon>add</mat-icon>
        Adicionar Projeto
      </button>
    </div>
  </div>

  <div class="filter-buttons" *ngIf="isSecretaria">
    <button (click)="setFiltroStatus('')" [class.active]="filtroStatus === ''">
      <mat-icon>description</mat-icon>
      Todos
    </button>
    <button
      (click)="setFiltroStatus('CONCLUIDO')"
      [class.active]="filtroStatus === 'CONCLUIDO'"
    >
      <mat-icon>check_circle</mat-icon>
      Concluídos
    </button>
  </div>

  <div class="content-area">
    <span #topSentinel></span>

    <div *ngIf="carregando" class="loading">
      <p>
        <mat-icon>sync</mat-icon>
        Carregando projetos...
      </p>
    </div>

    <div *ngIf="erro" class="error-message">
      <p>
        <mat-icon>warning_amber</mat-icon>
        {{ erro }}
      </p>
      <button class="btn-retry" (click)="recarregar()">
        <mat-icon>refresh</mat-icon>
        Tentar novamente
      </button>
    </div>

    <div *ngIf="!carregando && !erro" class="card-grid">
      <div
        *ngFor="let projeto of paginatedList; let i = index; trackBy: trackByFn"
        class="card"
        data-projeto-card
      >
        <div
          class="progress-bar"
          [ngStyle]="{
            width: calcularProgresso(projeto) + '%',
            background: cores[i % cores.length]
          }"
        ></div>

        <div class="card-body">
          <div class="card-menu" *ngIf="isSecretaria">
            <button
              class="menu-trigger"
              type="button"
              (click)="toggleMenu(projeto.id)"
              [attr.aria-expanded]="menuAberto === projeto.id"
              aria-haspopup="menu"
              aria-label="Abrir ações do projeto"
            >
              <mat-icon>more_vert</mat-icon>
            </button>

            <div
              class="menu-dropdown"
              *ngIf="menuAberto === projeto.id"
              role="menu"
            >
              <button
                class="menu-item danger"
                type="button"
                role="menuitem"
                (click)="cancelarProjeto(projeto.id)"
              >
                <mat-icon>block</mat-icon>
                Cancelar Projeto
              </button>
              <button
                class="menu-item warning"
                type="button"
                role="menuitem"
                (click)="tornarAlunosInadimplentes(projeto.id)"
              >
                <mat-icon>report_problem</mat-icon>
                Tornar Alunos Inadimplentes
              </button>
              <button
                class="menu-item warning"
                type="button"
                role="menuitem"
                (click)="tornarOrientadorInadimplente(projeto.id)"
              >
                <mat-icon>report_problem</mat-icon>
                Tornar Orientador Inadimplente
              </button>
              <button
                class="menu-item danger"
                type="button"
                role="menuitem"
                (click)="tornarTodosInadimplentes(projeto.id)"
              >
                <mat-icon>cancel</mat-icon>
                Tornar Todos Inadimplentes
              </button>
              <button
                class="menu-item success"
                type="button"
                role="menuitem"
                (click)="concluirProjeto(projeto.id)"
              >
                <mat-icon>flag_circle</mat-icon>
                Concluir Projeto
              </button>
            </div>
          </div>

          <h3 class="titulo" [title]="projeto.nomeProjeto">
            {{ projeto.nomeProjeto }}
          </h3>

          <div class="orientador-info">
            <mat-icon>person</mat-icon>
            <strong>Orientador:</strong>
            <span
              class="truncate"
              [class.orientador-vazio]="!temOrientador(projeto)"
              [title]="getOrientadorNome(projeto)"
            >
              {{ getOrientadorNomeCurto(projeto) }}
            </span>
          </div>

          <div class="campus-info">
            <mat-icon>school</mat-icon>
            <strong>Campus:</strong>
            <span>{{ projeto.campus || "—" }}</span>
          </div>

          <div class="alunos-lista">
            <strong>Alunos Participantes:</strong>
            <div
              class="chips"
              *ngIf="getNomesAlunos(projeto).length > 0; else semAlunos"
            >
              <span
                class="chip"
                *ngFor="let a of getNomesAlunos(projeto) | slice : 0 : 2"
              >
                <mat-icon>person</mat-icon>
                {{ a }}
              </span>
              <span
                class="chip count"
                *ngIf="getNomesAlunos(projeto).length > 2"
              >
                +{{ getNomesAlunos(projeto).length - 2 }}
              </span>
            </div>
            <ng-template #semAlunos>
              <span class="no-alunos">Nenhum aluno cadastrado</span>
            </ng-template>
          </div>
        </div>

        <div class="card-actions">
          <ng-container *ngIf="isSecretaria">
            <button (click)="editarProjeto(projeto.id)" class="btn-edit">
              <mat-icon>edit</mat-icon>
              Editar
            </button>
            <button (click)="excluirProjeto(projeto.id)" class="btn-delete">
              <mat-icon>delete</mat-icon>
              Excluir
            </button>
          </ng-container>

          <ng-container *ngIf="!isSecretaria && isOrientador">
            <ng-container *ngIf="temIdValido(projeto); else orientadorDisabled">
              <a
                class="btn-report"
                [routerLink]="['/orientador/relatorios', projeto.id]"
              >
                <mat-icon>assignment</mat-icon>
                Relatórios
              </a>
              <a
                class="btn-edit"
                [routerLink]="['/orientador/projetos', projeto.id]"
              >
                <mat-icon>group_add</mat-icon>
                Selecionar Alunos
              </a>
            </ng-container>

            <ng-template #orientadorDisabled>
              <button class="btn-report" disabled>
                <mat-icon>assignment</mat-icon>
                Relatórios
              </button>
              <button class="btn-edit" disabled>
                <mat-icon>group_add</mat-icon>
                Selecionar Alunos
              </button>
            </ng-template>
          </ng-container>

          <ng-container *ngIf="isAluno">
            <ng-container *ngIf="temIdValido(projeto); else alunoDisabled">
              <a class="btn-report" [routerLink]="['/aluno/projetos', projeto.id]">
                <mat-icon>visibility</mat-icon>
                Ver Projeto
              </a>

              <ng-container *ngIf="foiSelecionado(projeto.id); else blocoInscricao">
                <button
                  type="button"
                  class="btn-add btn-inscrito"
                  disabled
                  title="Você foi selecionado neste projeto"
                >
                  <mat-icon>verified</mat-icon>
                  Selecionado
                </button>
              </ng-container>

              <ng-template #blocoInscricao>
                <button
                  type="button"
                  class="btn-add"
                  [class.btn-inscrito]="jaInscrito(projeto.id)"
                  (click)="inscrever(projeto)"
                  [disabled]="inscrevendoId === projeto.id || jaInscrito(projeto.id)"
                  [title]="
                    jaInscrito(projeto.id)
                      ? 'Você já está inscrito neste projeto'
                      : 'Inscrever-se no projeto'
                  "
                >
                  <mat-icon>check_circle</mat-icon>

                  <ng-container *ngIf="inscrevendoId === projeto.id; else labelInscricao">
                    Inscrevendo...
                  </ng-container>

                  <ng-template #labelInscricao>
                    {{ jaInscrito(projeto.id) ? "Inscrito" : "Inscrever-se" }}
                  </ng-template>
                </button>
              </ng-template>
            </ng-container>

            <ng-template #alunoDisabled>
              <a class="btn-report" disabled>
                <mat-icon>visibility</mat-icon>
                Ver Projeto
              </a>
              <button type="button" class="btn-add" disabled>
                <mat-icon>check_circle</mat-icon>
                Inscrever-se
              </button>
            </ng-template>
          </ng-container>
        </div>
      </div>
    </div>

    <div *ngIf="!carregando && !erro && projetos.length === 0" class="no-projects">
      <h3>
        <mat-icon>folder</mat-icon>
        Nenhum projeto encontrado
      </h3>
      <p *ngIf="isSecretaria">Comece criando seu primeiro projeto!</p>
      <p *ngIf="!isSecretaria && isOrientador">Você ainda não está vinculado a um projeto.</p>
      <p *ngIf="!isSecretaria && !isOrientador">Não há projetos disponíveis no momento.</p>
      <button
        class="btn-add"
        *ngIf="isSecretaria"
        [routerLink]="['/secretaria/projetos/novo']"
      >
        <mat-icon>add</mat-icon>
        Criar primeiro projeto
      </button>
    </div>

    <div
      *ngIf="
        !carregando &&
        !erro &&
        projetos.length > 0 &&
        projetosFiltradosLista.length === 0
      "
      class="no-results"
    >
      <h3>
        <mat-icon>search</mat-icon>
        Nenhum resultado encontrado
      </h3>
      <p>Tente ajustar os termos da sua busca.</p>
      <button
        class="btn-clear-filter"
        (click)="onFiltroChange(''); setFiltroStatus('')"
        *ngIf="isSecretaria"
      >
        <mat-icon>backspace</mat-icon>
        Limpar filtro
      </button>
    </div>
  </div>

  <div class="pagination">
    <button class="page-btn" (click)="prevPage()" [disabled]="currentPage === 1">
      ‹
    </button>
    <span class="page-label">Página {{ currentPage }} / {{ totalPages }}</span>
    <button
      class="page-btn"
      (click)="nextPage()"
      [disabled]="currentPage === totalPages"
    >
      ›
    </button>
  </div>
</div>
