<h2>{{ tituloPagina }}</h2>

<div class="page">
  <div class="editor-grid">
    <div class="col-form">
      <form class="form-container" (ngSubmit)="salvarProjeto()" *ngIf="projeto">
        <label for="codProjeto"
          ><i class="fas fa-hashtag"></i> Código do Projeto</label
        >
        <input
          id="codProjeto"
          type="text"
          [(ngModel)]="projeto.cod_projeto"
          name="cod_projeto"
          placeholder="Ex.: P-2025-AB12CD"
          [disabled]="isReadOnly"
        />

        <label for="titulo"
          ><i class="fas fa-book"></i> Título do Projeto</label
        >
        <input
          id="titulo"
          type="text"
          [(ngModel)]="projeto.titulo_projeto"
          name="titulo_projeto"
          required
          [disabled]="isReadOnly"
        />

        <label for="resumo"
          ><i class="fas fa-align-left"></i> Resumo do Projeto</label
        >
        <textarea
          id="resumo"
          [(ngModel)]="projeto.resumo"
          name="resumo"
          required
          [disabled]="isReadOnly"
        ></textarea>

        <label for="buscaOrientador"
          ><i class="fas fa-search"></i> Buscar Orientador</label
        >
        <input
          id="buscaOrientador"
          type="text"
          [(ngModel)]="buscaOrientador"
          (input)="filtrarOrientadores()"
          name="busca_orientador"
          placeholder="Digite o nome do orientador"
          [disabled]="isReadOnly"
        />

        <label for="selectOrientador"
          ><i class="fas fa-user-tie"></i> Selecionar Orientador</label
        >
        <select
          id="selectOrientador"
          [(ngModel)]="orientadorSelecionadoId"
          (change)="selecionarOrientador($event)"
          required
          name="orientadorSelecionadoId"
          [disabled]="isReadOnly"
        >
          <option value="">-- Selecione --</option>
          <option
            *ngFor="let orientador of orientadoresFiltrados"
            [value]="orientador.id"
          >
            {{ formatarNomeCompleto(orientador.nome_completo) }}
          </option>
        </select>

        <label for="email_orientador"
          ><i class="fas fa-envelope"></i> E-mail do Orientador</label
        >
        <input
          id="email_orientador"
          type="email"
          [value]="emailOrientador"
          name="email_orientador"
          readonly
        />

        <label for="selectCampus"><i class="fas fa-building"></i> Campus</label>
        <select
          id="selectCampus"
          [(ngModel)]="campusSelecionadoId"
          (change)="selecionarCampus($event)"
          required
          name="campusSelecionadoId"
          [disabled]="isReadOnly"
        >
          <option value="">-- Selecione --</option>
          <option
            *ngFor="let campus of campusFiltrados"
            [value]="campus.id_campus"
          >
            {{ campus.campus }}
          </option>
        </select>

        <!-- DOCX inicial (apenas no cadastro / não aparece em read-only) -->
        <div class="upload-row" *ngIf="!modoEdicao && !isReadOnly">
          <label for="docxIdeia">
            <i class="fas fa-file-word"></i> Documento inicial (.docx) - Ideia
            do Projeto
          </label>
          <div class="upload-controls">
            <input
              id="docxIdeia"
              type="file"
              accept=".docx"
              (change)="onFileSelected($event, 'docx')"
              aria-label="Selecionar DOCX inicial"
              required
            />
          </div>
          <small class="hint">
            Obrigatório no cadastro. Será armazenado como versão editável da
            ideia inicial.
          </small>
        </div>

        <!-- PDF inicial (apenas no cadastro / não aparece em read-only) -->
        <div class="upload-row" *ngIf="!modoEdicao && !isReadOnly">
          <label for="pdfIdeia">
            <i class="fas fa-file-pdf"></i> Documento inicial (.pdf) - Ideia do
            Projeto
          </label>
          <div class="upload-controls">
            <input
              id="pdfIdeia"
              type="file"
              accept=".pdf"
              (change)="onFileSelected($event, 'pdf')"
              aria-label="Selecionar PDF inicial"
              required
            />
          </div>
          <small class="hint">
            Também obrigatório no cadastro. Será armazenado como versão em PDF
            da ideia inicial.
          </small>
        </div>

        <!-- Upload pós-cadastro (PARCIAL / FINAL) - oculto em read-only -->
        <div class="upload-section" *ngIf="!isReadOnly && projetoId > 0">
          <div
            class="card-header"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: var(--spacing-lg);
            "
          >
            <div>
              <h3 style="margin: 0">
                <i class="fas fa-file-upload"></i> Documentos do projeto
              </h3>
              <small>
                Etapa atual:
                <strong>{{ tituloEtapa(currentEtapaUpload) }}</strong>
              </small>
              <div>
                <small class="hint">
                  Selecione os arquivos e clique em
                  <strong>Atualizar Projeto</strong> para enviar.
                </small>
              </div>
            </div>

            <button
              type="button"
              class="btn btn-warning"
              [disabled]="!podeAvancar"
              title="Avançar para a próxima etapa"
              (click)="avancarEtapa()"
            >
              <i class="fas fa-forward"></i> {{ labelBotaoAvancar }}
            </button>
          </div>

          <div class="upload-row">
            <label for="docxFile">
              <i class="fas fa-file-word"></i> {{ tituloUploadAtual }} (.docx)
            </label>
            <div class="upload-controls">
              <input
                #docxInput
                type="file"
                id="docxFile"
                accept=".docx"
                (change)="onFileSelected($event, 'docx')"
                aria-label="Selecionar arquivo DOCX"
              />
            </div>
            <small class="hint" *ngIf="!arquivoDocx">
              Selecione um arquivo .docx (o envio acontece ao clicar em
              Atualizar Projeto).
            </small>
          </div>

          <div class="upload-row">
            <label for="pdfFile">
              <i class="fas fa-file-pdf"></i> {{ tituloUploadAtual }} (.pdf)
            </label>
            <div class="upload-controls">
              <input
                #pdfInput
                type="file"
                id="pdfFile"
                accept=".pdf"
                (change)="onFileSelected($event, 'pdf')"
                aria-label="Selecionar arquivo PDF"
              />
            </div>
            <small class="hint" *ngIf="!arquivoPdf">
              Selecione um arquivo .pdf (o envio acontece ao clicar em Atualizar
              Projeto).
            </small>
          </div>

          <small class="hint" *ngIf="!podeAvancar">
            Para avançar de etapa, envie o PDF desta fase (selecione e clique em
            Atualizar Projeto).
          </small>
        </div>

        <div class="history-section" *ngIf="projetoId > 0">
          <h3><i class="fas fa-history"></i> Histórico de Documentos</h3>

          <div class="cards-history">
            <div class="history-card" *ngFor="let h of historico">
              <div class="history-card-header">
                <i [ngClass]="iconeEtapa(h.etapa)"></i>
                <div>
                  <div class="title">{{ tituloEtapa(h.etapa) }}</div>
                  <div class="subtitle">{{ subtituloEtapa(h.etapa) }}</div>
                </div>
              </div>

              <div
                class="status"
                [class.nao-enviado]="h.status === 'NAO_ENVIADO'"
              >
                <ng-container *ngIf="h.status === 'ENVIADO'; else naoEnviado">
                  {{
                    h.dataEnvio
                      ? "Enviado em " +
                        (h.dataEnvio | date : "dd/MM/yyyy HH:mm")
                      : "Enviado"
                  }}
                </ng-container>
                <ng-template #naoEnviado> Não enviado </ng-template>
              </div>

              <div class="actions">
                <button
                  type="button"
                  class="btn ghost"
                  [disabled]="!h.arquivos?.pdf"
                  (click)="baixarArquivo('pdf', h.etapa)"
                >
                  <i class="fas fa-file-pdf"></i> PDF
                </button>
                <button
                  type="button"
                  class="btn ghost"
                  [disabled]="!h.arquivos?.docx"
                  (click)="baixarArquivo('docx', h.etapa)"
                >
                  <i class="fas fa-file-word"></i> DOCX
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Ações (oculta para ALUNO/ORIENTADOR) -->
        <div class="form-actions" *ngIf="!isReadOnly">
          <button type="submit">
            <i class="fas fa-save"></i> {{ textoBotao }}
          </button>
          <button type="button" class="btn-cancel" (click)="voltar()">
            <i class="fas fa-arrow-left"></i> Cancelar
          </button>
        </div>

        <!-- Apenas botão Voltar para ALUNO/ORIENTADOR -->
        <div class="form-actions" *ngIf="isReadOnly">
          <button type="button" class="btn-cancel" (click)="voltar()">
            <i class="fas fa-arrow-left"></i> Voltar
          </button>
        </div>
      </form>
    </div>

    <!-- Lista de alunos não aparece para ALUNO -->
    <div class="col-inscritos" *ngIf="projetoId > 0 && viewMode !== 'ALUNO'">
      <app-listagem-alunos
        [projetoId]="projetoId"
        [modo]="viewMode === 'ORIENTADOR' ? 'ORIENTADOR' : 'SECRETARIA'"
      ></app-listagem-alunos>
    </div>
  </div>
</div>
