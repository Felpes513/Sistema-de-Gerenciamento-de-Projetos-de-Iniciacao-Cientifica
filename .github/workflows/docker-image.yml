name: Frontend Docker CI

on:
    push:
        branches:
            - main
            - develop
        paths:
            - "src/**"
            - "angular.json"
            - "package.json"
            - "Dockerfile"
            - "docker-compose.yml"
            - ".github/workflows/docker-image.yml"
    pull_request:
        branches:
            - main
            - develop
        paths:
            - "src/**"
            - "angular.json"
            - "package.json"
            - "Dockerfile"
            - "docker-compose.yml"
            - ".github/workflows/docker-image.yml"

jobs:
    test:
        name: Run Tests
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci --legacy-peer-deps

            - name: Run linter (if configured)
              run: npm run lint || echo "No lint script found, skipping..."

            - name: Run tests
              run: npm test -- --watch=false --browsers=ChromeHeadless
              env:
                  CI: true

    build:
        name: Build Docker Image
        runs-on: ubuntu-latest
        needs: test

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker image (load into local Docker)
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./Dockerfile
                  push: false # n√£o envia pra registry nesse job
                  load: true # carrega a imagem no daemon local
                  tags: fronttcc-frontend:latest
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Test Docker image
              run: |
                  set -e

                  echo "‚ñ∂Ô∏è Subindo container a partir da imagem fronttcc-frontend:latest..."
                  docker run -d --name test-container -p 8080:80 fronttcc-frontend:latest

                  echo "‚è≥ Aguardando aplica√ß√£o responder na porta 8080..."

                  OK=0
                  # tenta por ~30s (10 tentativas x 3s)
                  for i in {1..10}; do
                    if curl -fsS http://localhost:8080 >/dev/null 2>&1; then
                      echo "‚úÖ Aplica√ß√£o respondeu na tentativa $i"
                      OK=1
                      break
                    fi
                    echo "Tentativa $i falhou, aguardando..."
                    sleep 3
                  done

                  if [ "$OK" -ne 1 ]; then
                    echo "‚ùå Aplica√ß√£o n√£o respondeu na porta 8080."
                    echo "üîé Logs do container:"
                    docker logs test-container || true

                    echo "üì¶ Containers em execu√ß√£o:"
                    docker ps -a || true

                    docker stop test-container || true
                    exit 1
                  fi

                  echo "‚úÖ Teste HTTP passou, encerrando container..."
                  docker stop test-container

    push:
        name: Push Docker Image to GHCR
        runs-on: ubuntu-latest
        needs: build
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        permissions:
            contents: read
            packages: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ghcr.io/${{ github.repository_owner }}/fronttcc-frontend
                  tags: |
                      type=ref,event=branch
                      type=sha,prefix={{branch}}-
                      type=raw,value=latest,enable={{is_default_branch}}

            - name: Build and push
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./Dockerfile
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
